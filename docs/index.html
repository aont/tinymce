<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TinyMCE リッチテキスト → HTML 出力ツール</title>

  <!-- TinyMCE (URLは変更しない) -->
  <script src="./tinymce/tinymce.min.js" referrerpolicy="origin"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif;
      margin: 0;
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
    }

    /* ★ 横並び → 縦並びに変更 */
    main {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 12px 16px;
    }

    .panel {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }

    .panel h2 {
      margin: 0;
      padding: 10px 12px;
      font-size: 14px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }

    .panel .content {
      padding: 12px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
    }

    button {
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
    }

    button:hover {
      background: #f3f4f6;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    textarea {
      width: 100%;
      min-height: 220px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
    }

    iframe {
      width: 100%;
      height: 360px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
    }

    .note {
      color: #6b7280;
      font-size: 12px;
      line-height: 1.5;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <header>
    <div style="display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;">
      <h1 style="font-size:16px; margin:0;">TinyMCE リッチテキスト編集 → HTMLツール</h1>
      <div style="color:#6b7280; font-size:12px;">
        保存/読込(localStorage)・HTML出力・プレビュー・ファイル出力
      </div>
    </div>
  </header>

  <div class="toolbar">
    <div class="row">
      <button id="btnSave">保存（localStorage）</button>
      <button id="btnLoad">読込（localStorage）</button>
      <button id="btnToHtml">HTMLを下に反映</button>
      <button id="btnPreview">プレビュー更新</button>
      <button id="btnCopy">HTMLコピー</button>
      <button id="btnDownload">HTMLをダウンロード</button>
      <label style="display:inline-flex; gap:8px; align-items:center;">
        <span style="font-size:12px; color:#374151;">HTMLファイル読み込み</span>
        <input id="fileInput" type="file" accept=".html,.htm,text/html" />
      </label>
    </div>
  </div>

  <main>
    <!-- 上：TinyMCE エディター -->
    <section class="panel">
      <h2>リッチテキスト編集（TinyMCE）</h2>
      <div class="content">
        <textarea id="editor">
<h2>サンプル</h2>
<p><strong>TinyMCE</strong> で編集した内容を <em>HTML</em> として保存できます。</p>
<ul>
  <li>太字 / 斜体 / 下線</li>
  <li>リンク・表・リスト</li>
  <li>コード表示（Source Code）</li>
</ul>
        </textarea>
        <div class="note">
          画像は「貼り付け」または「画像ボタン」で挿入できます（base64 埋め込み）。<br>
          サーバー保存する場合は images_upload_handler を差し替えてください。
        </div>
      </div>
    </section>

    <!-- 下：HTML 出力 + プレビュー -->
    <section class="panel">
      <h2>出力HTML（編集結果）</h2>
      <div class="content">
        <textarea id="htmlOutput" spellcheck="false"></textarea>

        <div style="height:12px;"></div>

        <h2 style="margin:10px 0 8px; font-size:14px;">プレビュー</h2>
        <iframe id="preview"></iframe>

        <div class="note">
          プレビューは iframe に HTML を直接書き込みます。<br>
          外部 CSS / JS を使う場合は iframe 側に含めてください。
        </div>
      </div>
    </section>
  </main>

  <script>
    const defaultLang =
      (navigator.language && navigator.language.startsWith("ja")) ? "ja" : "en";

    tinymce.init({
      selector: '#editor',
      license_key: 'gpl',
      language: defaultLang,
      height: 420,
      menubar: 'file edit view insert format tools table help',
      plugins: [
        'lists', 'link', 'image', 'table', 'code', 'fullscreen',
        'autosave', 'wordcount', 'preview', 'searchreplace',
        'visualblocks', 'help'
      ],
      toolbar: [
        'undo redo | blocks | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify',
        '| bullist numlist outdent indent | link image table | removeformat | code fullscreen'
      ].join(' '),

      autosave_ask_before_unload: true,
      autosave_interval: '30s',
      autosave_prefix: 'tinymce-autosave-{path}{query}-{id}-',
      autosave_restore_when_empty: true,

      images_upload_handler: (blobInfo) =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject('Image read failed');
          reader.readAsDataURL(blobInfo.blob());
        }),

      setup: (editor) => {
        editor.on('init', () => {
          const saved = localStorage.getItem('rte_html_saved');
          if (saved && editor.getContent({ format: 'html' }).trim() === '') {
            editor.setContent(saved);
          }
        });
      }
    });

    const htmlOutput = document.getElementById('htmlOutput');
    const preview = document.getElementById('preview');

    function getHtml() {
      const ed = tinymce.get('editor');
      return ed ? ed.getContent({ format: 'html' }) : '';
    }

    function setHtmlToOutput() {
      htmlOutput.value = getHtml();
    }

    function updatePreview() {
      const html = htmlOutput.value || getHtml();
      const doc = preview.contentDocument || preview.contentWindow.document;
      doc.open();
      doc.write(`<!doctype html><html><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body {
  font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif;
  padding: 14px;
}
</style>
</head><body>${html}</body></html>`);
      doc.close();
    }

    document.getElementById('btnSave').onclick = () => {
      localStorage.setItem('rte_html_saved', getHtml());
      setHtmlToOutput();
      alert('保存しました');
    };

    document.getElementById('btnLoad').onclick = () => {
      const saved = localStorage.getItem('rte_html_saved');
      if (!saved) return alert('保存データがありません');
      tinymce.get('editor').setContent(saved);
      setHtmlToOutput();
      updatePreview();
    };

    document.getElementById('btnToHtml').onclick = setHtmlToOutput;

    document.getElementById('btnPreview').onclick = () => {
      setHtmlToOutput();
      updatePreview();
    };

    document.getElementById('btnCopy').onclick = async () => {
      setHtmlToOutput();
      await navigator.clipboard.writeText(htmlOutput.value);
      alert('HTMLをコピーしました');
    };

    document.getElementById('btnDownload').onclick = () => {
      setHtmlToOutput();
      const blob = new Blob([htmlOutput.value], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'content.html';
      a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      tinymce.get('editor').setContent(text);
      setHtmlToOutput();
      updatePreview();
      e.target.value = '';
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        setHtmlToOutput();
        updatePreview();
      }, 600);
    });
  </script>
</body>
</html>
